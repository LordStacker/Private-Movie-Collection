<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.movie_collection.dal.mappers.MovieMapperDAO">

    <resultMap id="movieResult" type="Movie">
        <id property="id" column="movieId"/>
        <result property="name" column="movieName"/>
        <result property="rating" column="movieRating"/>
        <result property="absolutePath" column="moviePath"/>
        <result property="lastview" column="lastview"/>
        <collection property="categories" javaType="ArrayList" column="movieId" ofType="Category" >
            <id property="id" column="idCat"/>
            <result property="name" column="nameCat"/>
        </collection>
    </resultMap>

    <select id="getAllMovies"
            resultType="Movie"
            resultMap="movieResult">
        SELECT M.id     as movieId,-->
               M.name   as movieName,-->
               M.rating as movieRating,-->
               M.path   as moviePath,-->
               M.lastview as lastview,-->
               C.id     as idCat,-->
               C.name   as nameCat-->
        FROM Movie AS M -->
                 left outer join CatMovie PT on M.id = PT.movieId
                 left outer join Category C on PT.categoryId = C.id
    </select>


    <select id="getAllMoviesByCategoryId"
            resultType="Movie"
            resultMap="movieResult">
        SELECT M.id     as movieId,-->
               M.name   as movieName,-->
               M.rating as movieRating,-->
               M.path   as moviePath,-->
               M.lastview as lastview,-->
               C.id     as idCat,-->
               C.name   as nameCat-->
        FROM Movie AS M -->
                 left outer join CatMovie PT on M.id = PT.movieId
                 left outer join Category C on PT.categoryId = C.id
        WHERE C.id = #{value}  -- this could be more safer -->
    </select>


    <insert
            id="createMovieTest"
            parameterType="Movie"
            flushCache="true"
            statementType="PREPARED"
            keyProperty=""
            keyColumn=""
            useGeneratedKeys="true"
            timeout="20">

        INSERT INTO Movie (name, rating, path) VALUES (#{name},#{rating},#{absolutePath})
    </insert>


<!--  cache should be cleared before the statement is executed  ->  ensure that stale data is not used-->
<!--     timeout 20 to prevent any issues with a query taking too long to execute -->
    <delete id="deleteMovieById"
            parameterType="Movie"
            flushCache="true"
            statementType="PREPARED"
            timeout="20">

--         executes delete query
        DELETE FROM MOVIE WHERE id = #{value}
    </delete>





<!--    <select id="getCategoriesByMovieId" resultType="com.movie_collection.be.Category2" resultMap="movieResult">-->
<!--        SELECT * FROM category-->
<!--        WHERE id in (SELECT categoryId FROM CatMovie WHERE movieId = #{id})-->
<!--    </select>-->

<!--    column="idMovie" WAS INSIDE COLLECTION -->
<!--    <resultMap id="categoryResult" type="Category">-->
<!--        <collection property="categories" javaType="ArrayList" column="id" ofType="Category" select="selectPostsForBlog"/>-->
<!--    </resultMap>-->

<!--    <select id="selectBlog" resultMap="blogResult">-->
<!--        SELECT * FROM Movie WHERE ID = #{id}-->
<!--    </select>-->


    <!-- MAP CATEGORY -->
    <!--    <resultMap id="categoryResult" type="com.movie_collection.be.Category2">-->
    <!--        <result property="id" column="c_category_id"/>-->
    <!--        <result property="name" column="c_name"/>-->
    <!--    </resultMap>-->





</mapper>





<!--&#45;&#45; select  M.id     as idMovie,-->
<!--&#45;&#45;                 M.name   as name,-->
<!--&#45;&#45;                 M.rating as rating,-->
<!--&#45;&#45;                 M.path   as path,-->
<!--&#45;&#45;                 M.lastview as moviePath,-->
<!--&#45;&#45;                 C.id,C.name-->
<!--&#45;&#45;-->
<!--&#45;&#45; from movie m-->
<!--&#45;&#45;          inner join-->
<!--&#45;&#45;      CatMovie cm-->
<!--&#45;&#45;      on-->
<!--&#45;&#45;          m.id = cm.movieId-->
<!--&#45;&#45;          inner join-->
<!--&#45;&#45;      category c-->
<!--&#45;&#45;      on-->
<!--&#45;&#45;          cm.categoryId = c.id-->




<!--    &#45;&#45;         SELECT M.id     as idMovie,-->
<!--    &#45;&#45;                M.name   as name,-->
<!--    &#45;&#45;                M.rating as rating,-->
<!--    &#45;&#45;                M.path   as path,-->
<!--    &#45;&#45;                M.lastview as moviePath,-->
<!--    &#45;&#45;                C.id     as idCat,-->
<!--    &#45;&#45;                C.name   as nameCat-->
<!--    &#45;&#45;         FROM Movie AS M-->
<!--    &#45;&#45;                  left outer join CatMovie PT on M.id = PT.movieId-->
<!--    &#45;&#45;                  left outer join Category C on PT.categoryId = C.id-->


    <!--    <select id="selectAllMovies" resultMap="movieResult" resultType="com.movie_collection.be.Movie2">-->
    <!--        SELECT movie.id, movie.name, movie.rating, movie.path, movie.lastview, category.name as category_name-->
    <!--        FROM movie-->
    <!--        JOIN CatMovie CM ON Movie.id = CM.movieId-->
    <!--        JOIN category ON CM.categoryId = category.id-->
    <!--    </select>-->

    <!--    <select id="selectCategories" resultType="com.movie_collection.be.Category2">-->
    <!--        SELECT id,name from category where category.name in-->
    <!--        <foreach item="item" index="index" collection="list" open="(" separator="," close=")">-->
    <!--            #{item}-->
    <!--        </foreach>-->
    <!--    </select>-->

    <!--    <select id="selectCategories" resultType="com.movie_collection.be.Category2">-->
    <!--        SELECT name from category where category.id = #{id}-->
    <!--    </select>-->

    <!--    <select id="selectAll" resultMap="result" resultType="com.movie_collection.be.Movie2">-->
    <!--        SELECT id,name,rating,path,lastview FROM Movie;-->
    <!--    </select>-->
    <!--    <select id="selectById" parameterType="int" resultMap="result">-->
    <!--        SELECT * FROM user WHERE id = #{id}-->
    <!--    </select>-->

    <!--    <insert id="insert" parameterType="User" useGeneratedKeys="true" keyProperty="id">-->
    <!--        INSERT INTO user (userName) VALUES (#{userName});-->
    <!--    </insert>-->

    <!--    <update id="update" parameterType="User">-->
    <!--        UPDATE user-->
    <!--        SET userName = #{userName}-->
    <!--        WHERE id = #{id}-->
    <!--    </update>-->

    <!--    <delete id="delete" parameterType="int">-->
    <!--        DELETE from user WHERE id = #{id}-->
    <!--    </delete>
-->
